#include <Servo.h>
#include <Sleep_n0m1.h>
#include <EEPROM.h>
#define Photo A5; // Sets the input sensor for the photoresistor as analog 5 (do not change)
#define Solar A6;

Sleep sleep;
int read_solar();
double read_photoresistor(int pin);
unsigned long time;
int sleepLogger = 0;
Servo base_servo;
Servo panel_servo;

 void setup() {
    Serial.begin(9600); // This starts the Serial port allowing Octopus have a IO stream with laptop.
    base_servo.attach(9);
    panel_servo.attach(8);
    panel_servo.write(0);
    base_servo.write(0);
    /*
    for(int a = 0; a <= 180; a+=15) {
      Serial.println(a);
      panel_servo.write(a);
      base_servo.write(a);
      delay(5000);    
    }
    */
    //move_analog_motor(90,9);
    //runSolarSystem();
    
  }

  void loop() {
    solar_orient(A8, A9, A10, A11, 0, 0);
    //Serial.println(analogRead(A8));
    
  }

  void runSolarSystem(){
    double timeInMins = 0;
    for(int i = 0; i < 12; i++){
      //solar_orient() add parameters 
      time= millis();
      timeInMins = time / 60000; 
      int solar = read_solar();
      setEEPROMVal(2*i, timeInMins);
      setEEPROMVal(2*i + 1, solar);
      sleep.sleepDelay(600001);
    }
   }

  unsigned long getEEPROMVal(int index){
    unsigned long output = 0;
    output = EEPROM[2*index] * 256 + EEPROM[2*index+1];
    return output;
  }



  void setEEPROMVal(int index, int val){
    int firstNum = val / 256;
    int secondNum = val % 256;
    EEPROM[index*2] = firstNum;
    EEPROM[index*2 + 1] = secondNum;
  }



  int read_solar(){
      double solar = analogRead(A6);
      double voltage = solar * (5.0/1024.0); // converts analog to voltage
      return (int)(voltage * 100);
 }

  void move_analog_motor(int degrees, Servo analog){
      analog.write(degrees);
 }

  double  read_photoresistor(int pin){
      double light_level1 = analogRead(pin);
      double light_level2 = analogRead(pin);
      double light_level3 = analogRead(pin);
      double light_level = (light_level1 + light_level2 + light_level3) / 3.0;
      return light_level;
 }



  void solar_orient(int pin1, int pin2, int pin3, int pin4, int curDegBase, int curDegSolar){
    double photo_vals[4] = {read_photoresistor(pin1), read_photoresistor(pin2), read_photoresistor(pin3), read_photoresistor(pin4)};
    double max_value = 0;
    double min_value = 1024;
    for(int i=0; i < 4; i++){
        if(photo_vals[i] < min_value){
            min_value = photo_vals[i];
        }
        if(photo_vals[i] > max_value){
            max_value = photo_vals[i];
        }
      }
      double diffPer = 100 * (max_value - min_value) / ((max_value + min_value) / 2 ) ;
    if(diffPer < 5){
      return;
      }
    for(int a; a < 4; a++) {
      Serial.println(photo_vals[a]);
    }
      delay(5000);
    double topAvg = (photo_vals[0] + photo_vals[1]) / 2.0;
    //Serial.print("topAvg ");
    //Serial.println(topAvg);
    double botAvg = (photo_vals[2] + photo_vals[3]) / 2.0;
    //Serial.print("botAvg ");
    //Serial.println(botAvg);
    double leftAvg = (photo_vals[0] + photo_vals[2]) / 2.0;
    //Serial.print("leftAvg ");
    //Serial.println(leftAvg);
    double rightAvg = (photo_vals[1] + photo_vals[3]) / 2.0;
    //Serial.print("rightAvg ");
    //Serial.println(rightAvg);
    double upDiff = abs(topAvg - botAvg);
    //Serial.print("upDiff ");
    //Serial.println(upDiff);
    double leftDiff = abs(leftAvg - rightAvg);
    //Serial.print("leftDiff ");
    //Serial.println(leftDiff);
    delay(1000);
    if(upDiff > leftDiff){
            if(topAvg > botAvg){
                curDegSolar += 5;   
              }
            else /*if(botAvg > topAvg)*/{
                curDegSolar -= 5;
              }
            panel_servo.write(curDegSolar);
            Serial.print("curDegSolar = ");
            Serial.println(curDegSolar);
            delay(1000);
        }
    else/*(leftDiff > upDiff)*/{
            if(leftAvg > rightAvg){
                curDegBase += 5;   
              }
            else if(leftAvg > rightAvg){
                curDegBase -= 5;
              }
            base_servo.write(curDegBase);
            Serial.print("curDegBase = ");
            Serial.println(curDegBase);
            delay(1000);
        }

  solar_orient(pin1, pin2, pin3, pin4, curDegBase, curDegSolar);
  }

 
 
